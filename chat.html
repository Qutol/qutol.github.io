<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat on Qutol</title>
    <link rel="stylesheet" href="styles.css?v=1.1">
    <link rel="icon" href="images/QutolFavicon.png" type="image/x-icon">
</head>
<body style="padding:0;" id="body">
    <div id="message-container"></div>

    <form id="message-form" style="display: flex; width:calc(100%-40px); margin:20px; align-items: center;">
        <input id="message-input" name="message" style="height:30px; width:100%; margin:0; margin-right:20px" required>
        <button style="height: 40px;" type="submit">Send</button>
    </form>
    <div id="typer-container"></div>

    <div style="font-size: 0px;" id="username"></div>
    <script type="module">
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js"
        import { collection, getDocs, addDoc, Timestamp, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js"
        import { query, orderBy, limit, where, onSnapshot, doc, updateDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js"
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js'
        const firebaseConfig = {
            apiKey: "AIzaSyDgz1Q8bjUHnVZS7FP3OVlVisTy4VyEGlI",
            authDomain: "mediasite-2c522.firebaseapp.com",
            projectId: "mediasite-2c522",
            storageBucket: "mediasite-2c522.firebasestorage.app",
            messagingSenderId: "26314943690",
            appId: "1:26314943690:web:67c0d5e5494d6c49c1d833",
            measurementId: "G-5BR85RQZKB"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        var username = "";

        async function setUsername(uid) {
            const docRef = doc(db, "users", uid)
            const userDoc = await getDoc(docRef)
            username = userDoc.data().username
            document.getElementById("username").textContent = username
        }

        const auth = getAuth(app);

        var signedIn

        onAuthStateChanged(auth, (user) => {
            if (user) {
                signedIn = true
                const uid = user.uid;
                setUsername(uid)
            } else {
                window.location = "signin.html"
            }
        })

        // Function to automatically scroll to the bottom of the chat
        async function scrollToBottom() {
            await sleep(100)
            window.scrollTo(0, document.body.scrollHeight);
        }

        const messageContainer = document.getElementById("message-container");

        // Function to display a message in the container
        function instanciateMessage(text) {
            const message = document.createElement("div");
            message.textContent = text;
            message.className = "message";

            messageContainer.appendChild(message);
        }

        // Fetch initial messages from the server (GET request)
        const url = 'https://mc.darraghbennett.com/get';

        function post(message) {
            username = document.getElementById("username").textContent

            var typing = "!" + username;
            if(document.getElementById('message-input').value) {
                typing = username;
            }

            var messageText = ""
            
            if(message) {
                messageText = username + ": " + message
            }

            // Prepare the POST request
            const postUrl = 'https://mc.darraghbennett.com/post';
            const data = { message: messageText, typer: typing };
            fetch(postUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data), // Send the data as JSON
            })
            .then(response => response.text()) // First get the raw text response
            .then(responseText => {
                try {
                    const jsonData = JSON.parse(responseText); // Try parsing as JSON
                    instanciateMessage(jsonData.message); // Display the sent message
                    document.getElementById("typer-container").replaceChildren()
                    const typerDiv = document.createElement("div")
                    var typersArray = jsonData.typers
                    const index = typersArray.indexOf(username);
                    if (index > -1) {
                        typersArray.splice(index, 1);
                    }
                    if(typersArray.length != 0) {
                        typerDiv.textContent = "Typing: " + typersArray.join(", ")
                    }
                    typerDiv.id = "typer-div"
                    document.getElementById("typer-container").appendChild(typerDiv)
                    scrollToBottom(); // Scroll to the bottom of the chat
                } catch (error) {
                    console.error('Error parsing response as JSON:', error);
                }
            })
            .catch(error => {
                console.error('Error sending message:', error);
            });
        }

        async function fetchData() {
            while(true) {
                fetch(url)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        messageContainer.replaceChildren()
                        data[0].messages.forEach(message => {
                            instanciateMessage(message);
                        });
                    })
                    .catch(error => {
                        console.error('Error fetching data:', error);
                    });
                post("")
                await sleep(500)
            }
        }

        fetchData()

        // Handle form submission (POST request)
        const form = document.getElementById('message-form');
        form.addEventListener('submit', function(event) {
            event.preventDefault();

            const messageInput = document.getElementById('message-input');
            var messageText = messageInput.value.trim();

            document.getElementById("message-form").reset()
            if (messageText === '') {
                return; // Don't send empty messages
            }

            post(messageText)
        });

        scrollToBottom()
    </script>
</body>
</html>